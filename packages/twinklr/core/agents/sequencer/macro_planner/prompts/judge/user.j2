{#
MacroPlanner Judge User Prompt
Provides the MacroPlan to evaluate along with song context
#}
# Song Information

**Title:** {{ audio_profile.song_identity.title or "Untitled" }}
**Artist:** {{ audio_profile.song_identity.artist or "Unknown" }}
**Duration:** {{ (audio_profile.song_identity.duration_ms / 1000) | round(1) }}s
**BPM:** {{ audio_profile.song_identity.bpm | round(1) }}
**Energy:** {{ audio_profile.energy_profile.macro_energy.value }}

{% if lyric_context is defined and lyric_context %}
**Lyric Context Available:** Yes
- **Themes:** {{ lyric_context.themes | join(", ") }}
- **Mood Arc:** {{ lyric_context.mood_arc }}
- **Has Narrative:** {{ "Yes" if lyric_context.has_narrative else "No" }}
- **Key Phrases:** {{ lyric_context.key_phrases | length }} identified
- **Vocal Coverage:** {{ (lyric_context.vocal_coverage_pct * 100) | round(0) }}%
{% endif %}

## Song Structure

**Expected section count:** {{ audio_profile.structure.sections | length }}

{% for section in audio_profile.structure.sections %}
- **{{ section.name }}** ({{ section.section_id }}) - {{ (section.start_ms / 1000) | round(1) }}s to {{ (section.end_ms / 1000) | round(1) }}s{% if (section.end_ms - section.start_ms) < 2000 %} ⚡ pickup{% endif %}

{% endfor %}

## Display Layout

Available concrete display group IDs:
{% for group in display_groups %}
- **{{ group.id }}** ({{ group.model_count }} models)
{% endfor %}

Layer targets must match this exact list.

{% if available_zone_ids is defined and available_zone_ids %}
Available zone IDs:
{% for zone in available_zone_ids %}
- **{{ zone }}**
{% endfor %}
{% endif %}

{% if available_split_ids is defined and available_split_ids %}
Available split IDs:
{% for split in available_split_ids %}
- **{{ split }}**
{% endfor %}
{% endif %}

Focus targets must be typed objects using `type` in `group|zone|split` with IDs from the corresponding lists.

---

# Available Catalogs

{% if theme_catalog is defined and theme_catalog %}
## Theme Catalog (Valid theme_ids)

{% for t in theme_catalog %}
- **{{ t.theme_id }}** — {{ t.title }}
{% endfor %}
{% else %}
**Theme Catalog:** Not provided (cannot validate theme_ids)
{% endif %}

{% if palette_catalog is defined and palette_catalog %}
## Palette Catalog (Valid palette_ids)

{% for p in palette_catalog %}
- **{{ p.id }}** — {{ p.title }}{% if p.description %} - {{ p.description }}{% endif %}
{% endfor %}
{% else %}
**Palette Catalog:** Not provided (cannot validate palette_ids)
{% endif %}

{% if motif_catalog is defined and motif_catalog %}
## Motif Catalog (Valid motif_ids)

{% for m in motif_catalog %}
- **{{ m.id }}** (energy: {{ m.energy }}){% if m.description %} - {{ m.description }}{% endif %}
{% endfor %}
{% else %}
**Motif Catalog:** Not provided (cannot validate motif_ids)
{% endif %}

---

# MacroPlan to Evaluate

{% if iteration > 1 %}
**Iteration {{ iteration }}** - Evaluating refined plan. Check if previous feedback was addressed.
{% else %}
**Iteration 1** - Initial plan evaluation. Provide comprehensive feedback to guide refinement.
{% endif %}

## Global Story

**Theme ID:** {{ macro_plan.global_story.theme.theme_id }}
**Theme Scope:** {{ macro_plan.global_story.theme.scope.value if macro_plan.global_story.theme.scope is defined else macro_plan.global_story.theme.scope }}
**Theme Tags:** {{ macro_plan.global_story.theme.tags | join(', ') if macro_plan.global_story.theme.tags else "None" }}

{% if macro_plan.global_story.palette_plan is defined and macro_plan.global_story.palette_plan %}
**Palette Plan (structured field global_story.palette_plan):**
- Primary: {{ macro_plan.global_story.palette_plan.primary.palette_id }} (role: {{ macro_plan.global_story.palette_plan.primary.role.value }}, intensity: {{ macro_plan.global_story.palette_plan.primary.intensity }})
{% if macro_plan.global_story.palette_plan.alternates %}
- Alternates: {{ macro_plan.global_story.palette_plan.alternates | map(attribute='palette_id') | join(', ') }}
{% else %}
- Alternates: None
{% endif %}
{% else %}
**Palette Plan:** ❌ MISSING (ERROR: global_story.palette_plan.primary.palette_id is required)
{% endif %}

**Story Notes:** {{ macro_plan.global_story.story_notes }}
**Pacing Notes:** {{ macro_plan.global_story.pacing_notes }}

## Layering Plan

**Layer Count:** {{ macro_plan.layering_plan.layers | length }}

{% for layer in macro_plan.layering_plan.layers %}
- **Layer {{ layer.layer_index }}** ({{ layer.layer_role.value }}, {{ layer.blend_mode.value }} blend)
  - **Usage Notes:** {{ layer.usage_notes }}
  - **Timing:** {{ layer.timing_driver.value }}
  - **Targets:** {{ layer.target_selector.roles | join(', ') }}
  - **Intensity Bias:** {{ layer.intensity_bias }}
{% endfor %}

## Section Plans

**Plan provides {{ macro_plan.section_plans | length }} section plans** (expected: {{ audio_profile.structure.sections | length }}).

Use `section.section_id` as the canonical section identifier for coverage checks.
Primary/Secondary Focus lines below are human-readable projections of typed target objects; schema validity must be judged from the structured plan data.

{% for section in macro_plan.section_plans %}
### {{ section.section.name }} ({{ section.section.section_id }}) ({{ (section.section.start_ms / 1000) | round(1) }}s - {{ (section.section.end_ms / 1000) | round(1) }}s){% if (section.section.end_ms - section.section.start_ms) < 2000 %} ⚡ PICKUP (< 2s){% endif %}

- **Theme ID:** {{ section.theme.theme_id }}
- **Theme Scope:** {{ section.theme.scope.value if section.theme.scope else 'MISSING' }}
- **Theme Tags:** {{ section.theme.tags | join(', ') if section.theme.tags else 'None' }}

{% if section.palette is defined and section.palette %}
- **Palette Override:** {{ section.palette.palette_id }}
{% else %}
- **Palette Override:** None (inherit global)
{% endif %}

{% if section.motif_ids is defined and section.motif_ids %}
- **Motif IDs:** {{ section.motif_ids | join(', ') }}
{% else %}
- **Motif IDs:** MISSING
{% endif %}

- **Energy Target:** {{ section.energy_target.value }}
- **Motion Density:** {{ section.motion_density.value }}
- **Choreography Style:** {{ section.choreography_style.value }}
- **Primary Focus:**
{% if section.primary_focus_targets %}
{% for target in section.primary_focus_targets %}
  - {{ target.type.value if target.type is defined and target.type.value is defined else target.type }}:{{ target.id }}
{% endfor %}
{% else %}
  - None
{% endif %}
- **Secondary Targets:**
{% if section.secondary_targets %}
{% for target in section.secondary_targets %}
  - {{ target.type.value if target.type is defined and target.type.value is defined else target.type }}:{{ target.id }}
{% endfor %}
{% else %}
  - None
{% endif %}
- **Notes:** {{ section.notes }}

{% endfor %}

---

# Your Task

Evaluate this MacroPlan for a Christmas light show. Assess:
1. **Technical Validity**: Section coverage, layer architecture, target validity, palette plan, motif_ids
2. **Strategic Quality**: Story coherence, section appropriateness, bold impact, contrast, motif/palette cohesion
3. **Actionability**: Are section notes clear enough for group planners?

Provide a score (0-10), verdict status (APPROVE/SOFT_FAIL/HARD_FAIL), structured issues, and constructive feedback.

**Remember**: This is a **Christmas light show** for residential displays. Bold, impactful designs win. Subtle concepts get lost.
