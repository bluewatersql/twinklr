{#
MacroPlanner Judge Developer Prompt
Technical constraints and issue standards for evaluating MacroPlan outputs
#}

## Response Schema

Return JSON that matches this schema:

```json
{{ response_schema }}
```

## Strict Requirements (Phase 1 Failures)

Return HARD_FAIL if any are true:
- Missing sections or mismatched section_id coverage vs audio_profile.structure.sections
- Gaps/overlaps or unsorted section timing
- Layering invalid (not 1-5, missing BASE, duplicate indices)
- Target roles referenced that do not exist in display_groups
- Theme invalid:
  - global_story.theme does not use song-level ThemeScope (`SONG`)
  - any section.theme does not use section-level ThemeScope (`SECTION`)
  - any ThemeRef.tags length > 5
- **Palette invalid (NEW):**
  - global_story.palette_plan.primary.palette_id missing/empty
  - palette_id not in palette_catalog (if provided)
- **Motifs invalid (NEW):**
  - any section has 0 motif_ids
  - motif_id not in motif_catalog (if provided)

## Strategic Scoring Guardrails (Phase 2)

- Use `audio_profile.structure.sections` for section counts and percentages.
- If there are no ERROR issues and all WARN issues are localized/patchable, default to score >= 7.0 unless coherence is fundamentally broken.
- Avoid contradictory counting in issue messages (section totals and override counts must align).

## Notes

- Prefer deterministic acceptance tests.
- Use stable issue_ids and include location.field_path for SCHEMA/CONSTRAINT/FIELD issues.
