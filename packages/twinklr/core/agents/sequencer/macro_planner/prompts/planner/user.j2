{#
MacroPlanner User Prompt - INITIAL PLANNING
Provides song details, display layout, and task instructions.
Refinement iterations (2+) use user_refinement.j2 instead.
#}
# Song Information

**Title:** {{ audio_profile.song_identity.title or "Untitled" }}
**Artist:** {{ audio_profile.song_identity.artist or "Unknown" }}
**Duration:** {{ (audio_profile.song_identity.duration_ms / 1000) | round(1) }}s
**BPM:** {{ audio_profile.song_identity.bpm | round(1) }}
**Key:** {{ audio_profile.song_identity.key }}
**Time Signature:** {{ audio_profile.song_identity.time_signature }}

## Song Structure (YOU MUST PLAN ALL {{ audio_profile.structure.sections | length }} SECTIONS)

{% for section in audio_profile.structure.sections %}
- **{{ section.section_id }}** â€” {{ (section.start_ms / 1000) | round(1) }}s to {{ (section.end_ms / 1000) | round(1) }}s
{% endfor %}

**CRITICAL**: Your `section_plans` array MUST include exactly {{ audio_profile.structure.sections | length }} entries. Each entry's `section.section_id` MUST be the exact unique ID from the list above (e.g., `chorus_1`, NOT `chorus`). Copy `section_id` values verbatim â€” they include `_N` suffixes when a type repeats.

## Energy Profile

**Overall Energy:** {{ audio_profile.energy_profile.macro_energy.value }}

**Energy Peaks:** {{ audio_profile.energy_profile.peaks | length }} major peaks detected
{% if audio_profile.energy_profile.peaks %}
Peak timings:
{% for peak in audio_profile.energy_profile.peaks[:5] %}
- {{ (peak.start_ms / 1000) | round(1) }}s to {{ (peak.end_ms / 1000) | round(1) }}s (energy: {{ peak.energy | round(2) }})
{% endfor %}
{% if audio_profile.energy_profile.peaks | length > 5 %}
... and {{ audio_profile.energy_profile.peaks | length - 5 }} more peaks
{% endif %}
{% endif %}

## Theme Catalog (Allowed IDs)

Use only these theme_ids (do not invent). Prefer using the global theme for most sections.

{% for t in theme_catalog %}
- {{ t.theme_id }} â€” {{ t.title }}
{% endfor %}

## Palette Catalog (Valid palette_ids)

{% if palette_catalog is defined and palette_catalog %}
{% for p in palette_catalog %}
- **{{ p.id }}** â€” {{ p.title }}{% if p.description %} - {{ p.description }}{% endif %}
{% endfor %}
{% else %}
**Palette Catalog:** Not provided
{% endif %}

## Motif Catalog (Valid motif_ids)

{% if motif_catalog is defined and motif_catalog %}
{% for m in motif_catalog %}
- **{{ m.id }}** (energy: {{ m.energy }}){% if m.description %} - {{ m.description }}{% endif %}
{% endfor %}
{% else %}
**Motif Catalog:** Not provided
{% endif %}

## Creative Guidance

**Recommended Layer Count:** {{ audio_profile.creative_guidance.recommended_layer_count }}

**Recommended Contrast:** {{ audio_profile.creative_guidance.recommended_contrast.value }}

**Recommended Motion Density:** {{ audio_profile.creative_guidance.recommended_motion_density.value }}

**Palette Color Guidance:** {{ audio_profile.creative_guidance.palette_color_guidance | join(", ") or "Not specified" }}

{% if audio_profile.creative_guidance.cautions %}
**Cautions:** 
{% for caution in audio_profile.creative_guidance.cautions %}
- {{ caution }}
{% endfor %}
{% endif %}

{% if lyric_context is defined and lyric_context %}
## Lyric Context

**Has Lyrics:** Yes

**Themes:** {{ lyric_context.themes | join(", ") }}

**Mood Arc:** {{ lyric_context.mood_arc }}

**Genre Markers:** {{ lyric_context.genre_markers | join(", ") }}

{% if lyric_context.has_narrative %}
**Narrative:** Yes - {{ lyric_context.characters | length if lyric_context.characters else 0 }} character(s), {{ lyric_context.story_beats | length if lyric_context.story_beats else 0 }} story beat(s)

{% if lyric_context.story_beats %}
**Story Beats:**
{% for beat in lyric_context.story_beats[:3] %}
- **[{{ beat.beat_type }}]** {{ beat.section_id }} ({{ (beat.timestamp_range[0] / 1000) | round(1) }}s-{{ (beat.timestamp_range[1] / 1000) | round(1) }}s)
  {{ beat.description }}
  ðŸ’¡ {{ beat.visual_opportunity }}
{% endfor %}
{% if lyric_context.story_beats | length > 3 %}
... and {{ lyric_context.story_beats | length - 3 }} more story beats
{% endif %}
{% endif %}
{% endif %}

**Key Phrases:** {{ lyric_context.key_phrases | length }} memorable moments identified
{% if lyric_context.key_phrases %}
Notable examples:
{% for phrase in lyric_context.key_phrases[:5] %}
- "{{ phrase.text }}" @ {{ (phrase.timestamp_ms / 1000) | round(1) }}s [{{ phrase.emphasis }}]
  ðŸ’¡ {{ phrase.visual_hint }}
{% endfor %}
{% if lyric_context.key_phrases | length > 5 %}
... and {{ lyric_context.key_phrases | length - 5 }} more key phrases
{% endif %}
{% endif %}

**Recommended Visual Themes:** {{ lyric_context.recommended_visual_themes | join(", ") }}

**Lyric Density:** {{ lyric_context.lyric_density }}
**Vocal Coverage:** {{ (lyric_context.vocal_coverage_pct * 100) | round(0) }}%

{% if lyric_context.silent_sections %}
**Silent/Instrumental Sections:** {{ lyric_context.silent_sections | length }}
{% for section in lyric_context.silent_sections %}
- {{ (section.start_ms / 1000) | round(1) }}s to {{ (section.end_ms / 1000) | round(1) }}s ({{ (section.duration_ms / 1000) | round(1) }}s){% if section.section_id %} - {{ section.section_id }}{% endif %}
{% endfor %}
{% endif %}

**IMPORTANT:** Use the key phrases' visual hints as inspiration for choreography moments. Align story beats with section planning.

{% endif %}
## Display Layout

Available target roles in this display:
{% for group in display_groups %}
- **{{ group.role_key }}** ({{ group.group_type }}){% if group.element_kind is defined %} [{{ group.element_kind }}]{% endif %} - {{ group.model_count }} model{{ "s" if group.model_count != 1 else "" }}{% if group.pixel_fraction is defined %}, {{ (group.pixel_fraction * 100) | round(0) | int }}% of display{% endif %}{% if group.prominence is defined %} ({{ group.prominence }}){% endif %}

{% if group.horizontal is defined or group.arrangement is defined %}  Layout: {% if group.arrangement is defined %}{{ group.arrangement }}{% endif %}{% if group.horizontal is defined %} â€” {{ group.horizontal }}{% if group.vertical is defined %} / {{ group.vertical }}{% endif %}{% if group.depth is defined and group.depth != "NEAR" %} / {{ group.depth }}{% endif %}{% endif %}{% if group.zone is defined %} [{{ group.zone }}]{% endif %}

{% endif %}
{% endfor %}

# Your Task

Create a strategic MacroPlan for this Christmas light show that:

1. **Tells a story** - Define global theme, motifs, and pacing
2. **Plans each section** - Energy targets, choreography style, focus targets
3. **Designs layer architecture** - BASE, RHYTHM, ACCENT layers with proper blend modes
4. **Sets themes** - Provide global_story.theme (SONG) and section_plans[*].theme (SECTION) for downstream asset generation

## Motif Strategy (Critical for Cohesion)

Select 3-8 motifs total. Structure them as:
- **2-4 Core Motifs:** Must appear in 70%+ of sections (creates visual identity)
- **1-3 Spice Motifs:** Appear in 2-4 sections only (adds variety without sprawl)

Example for {{ audio_profile.structure.sections | length }} sections:
- Core: 3 motifs appearing in {{ ((audio_profile.structure.sections | length) * 0.7) | round(0) | int }}+ sections each
- Spice: 1-2 motifs appearing in 2-4 sections for specific moments

Remember: Bold impact, main character energy, coordinated wow moments!