{#
MacroPlanner Developer Prompt
Technical constraints and response schema
#}
## Response Schema

Return valid JSON matching this schema:

```json
{{ response_schema }}
```

## Historical Learning (Common Issues to Avoid)
- Common failure: IMAGERY used in only 0–1 sections for character-driven holiday songs; target 3–6 sections.
{% if learning_context is defined and learning_context %}
{{ learning_context }}
{% endif %}

Use this context to avoid common mistakes, but evaluate each song on its own merits.

---

## Technical Constraints

**Schema Version:** macro-plan.v2  
**Max Layers:** 5 (min 1, must include exactly one BASE layer)  
**Max Sections:** Match audio profile sections exactly

## Enum Values (Use These Exactly)

{% if taxonomy %}
**LayerRole:** {{ taxonomy.LayerRole | join(', ') }}  
**BlendMode:** {{ taxonomy.BlendMode | join(', ') }}  
**TimingDriver:** {{ taxonomy.TimingDriver | join(', ') }}  

**TargetRole:** {{ taxonomy.TargetRole | join(', ') }}  
**EnergyTarget:** {{ taxonomy.EnergyTarget | join(', ') }}  
**ChoreographyStyle:** {{ taxonomy.ChoreographyStyle | join(', ') }}  
**MotionDensity:** {{ taxonomy.MotionDensity | join(', ') }}
{% else %}
{# Fallback if taxonomy not provided #}
**LayerRole:** BASE, RHYTHM, ACCENT, HIGHLIGHT, FILL, TEXTURE, CUSTOM  
**BlendMode:** NORMAL, ADD, MASK  
**TimingDriver:** BEATS, DOWNBEATS, BARS, PHRASES, PEAKS, LYRICS  

**TargetRole:** OUTLINE, MEGA_TREE, HERO, ARCHES, TREES, PROPS, FLOODS, ACCENTS, MATRIX, MOVING_HEADS  
**EnergyTarget:** LOW, MED, HIGH, BUILD, RELEASE, PEAK  
**ChoreographyStyle:** IMAGERY, ABSTRACT, HYBRID  
**MotionDensity:** SPARSE, MED, BUSY
{% endif %}

## Theme Rules (Critical)

1. **Global theme is required**:
   - `global_story.theme` must be a ThemeRef using the song-level ThemeScope value (`SONG`).

2. **Every section must include a ThemeRef**:
   - `section_plans[*].theme` must use the section-level ThemeScope value (`SECTION`).
   - Keep `section_plans[*].theme.tags` to **0–5**.

3. **Defaulting rule (behavioral)**:
   - By default, set each section theme to match the global theme:
     - `section_plans[*].theme.theme_id == global_story.theme.theme_id`
   - Only change a section’s `theme_id` when there is a deliberate shift (breakdown/bridge/drop/genre/mood pivot).
   - When you override `theme_id`, add **1–2** tags in `section_plans[*].theme.tags` to justify the shift (e.g., `setting.calm`, `style.minimal`).
   - Section-type defaults (unless a strong reason otherwise)
      - **Intro/Outro:** HYBRID (establish/resolve scene)
      - **Chorus:** IMAGERY or HYBRID (recognizable icons / “hero moments”)
      - **Verses:** ABSTRACT or HYBRID (unless highly literal narrative)
      - **Bridge/Breakdown:** HYBRID (scene shift / special visual)

4. **No asset filenames**:
   - Do NOT output asset filenames in MacroPlan. Downstream AssetPlanner derives assets from templates/slots.

## Critical Rules (Violations Cause Validation Failures)

1. **Exactly one BASE layer** with NORMAL blend mode
2. **All other layers** use ADD blend mode
3. **Section coverage** must match audio profile exactly:
   - **CRITICAL**: Create one MacroSectionPlan for EVERY section in audio_profile.structure.sections
   - Each section_plans[].section must include the exact `section_id` from audio structure (e.g., "intro_1", "verse_1", "verse_2", "verse_3", "verse_4")
   - Use the exact section timing (start_ms, end_ms) from audio structure
   - No extra sections beyond what's in audio
   - No gaps or overlaps
   - Do NOT use generic labels without section_id
4. **Target roles** must be from available display groups

**Note on MASK blend mode:** While MASK exists in the schema, it is reserved for advanced use cases and should NOT be used in standard macro plans. Stick to NORMAL (for BASE layer only) and ADD (for all other layers).

## Quality Rules (Violations Trigger Warnings)

1. **Layer variety**: Use 2-4 layers for visual depth (1 layer = minimal, 5 = complex)
2. **Target variety**: Don't focus on the same target in >70% of sections
3. **Energy variety**: Vary energy targets across sections (not all the same)
4. **Motion density variety**: Mix SPARSE/MED/BUSY across sections (especially with 4+ sections)
5. **Choreography style**: Consider mixing IMAGERY/ABSTRACT/HYBRID for variety
6. **Motif cohesion**: Use 3-8 total motifs; 2-4 "core" motifs must appear in 70%+ of sections; 1-3 "spice" motifs can appear in select sections only
7. **Palette coherence**: Primary palette should be used in 70-80% of sections; limit palette overrides to 2-3 key moments
8. **Imagery coverage (narrative songs)**: For character/narrative holiday songs, avoid under-tagging IMAGERY—target **IMAGERY/HYBRID in 30–50% of sections** (typically **3–6 sections**). Bias choruses + intro/outro + one narrative verse/bridge.
9. **Timestamp validity (CRITICAL)**: All timestamp cues in section notes MUST fall within that section's time range:
   - Never reference timestamps from other sections
   - Example: intro (0-12s) notes should only mention times 0-12s, not 45s peaks
   - If a peak or cue falls outside the section, move that callout to the correct section
