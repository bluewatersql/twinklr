{#
MacroPlanner Developer Prompt
Technical constraints and response schema
#}
## Response Schema

Return valid JSON matching this schema:

```json
{{ response_schema }}
```

## Technical Constraints

**Schema Version:** macro-plan.v2  
**Max Layers:** 5 (min 1, must include exactly one BASE layer)  
**Max Sections:** Match audio profile sections exactly

## Enum Values (Use These Exactly)

{% if taxonomy %}
**LayerRole:** {{ taxonomy.LayerRole | join(', ') }}  
**BlendMode:** {{ taxonomy.BlendMode | join(', ') }}  
**TimingDriver:** {{ taxonomy.TimingDriver | join(', ') }}  

**TargetRole:** {{ taxonomy.TargetRole | join(', ') }}  
**EnergyTarget:** {{ taxonomy.EnergyTarget | join(', ') }}  
**ChoreographyStyle:** {{ taxonomy.ChoreographyStyle | join(', ') }}  
**MotionDensity:** {{ taxonomy.MotionDensity | join(', ') }}
{% else %}
{# Fallback if taxonomy not provided #}
**LayerRole:** BASE, RHYTHM, ACCENT, HIGHLIGHT, FILL, TEXTURE, CUSTOM  
**BlendMode:** NORMAL, ADD, MASK  
**TimingDriver:** BEATS, DOWNBEATS, BARS, PHRASES, PEAKS, LYRICS  

**TargetRole:** OUTLINE, MEGA_TREE, HERO, ARCHES, TREES, PROPS, FLOODS, ACCENTS, MATRIX, MOVING_HEADS  
**EnergyTarget:** LOW, MED, HIGH, BUILD, RELEASE, PEAK  
**ChoreographyStyle:** IMAGERY, ABSTRACT, HYBRID  
**MotionDensity:** SPARSE, MED, BUSY
{% endif %}

## Theme Rules (Critical)

1. **Global theme is required**:
   - `global_story.theme` must be a ThemeRef with `scope=SONG`.

2. **Every section must include a ThemeRef**:
   - `section_plans[*].theme.scope` must be `SECTION`.
   - Keep `section_plans[*].theme.tags` to **0–5**.

3. **Defaulting rule (behavioral)**:
   - By default, set each section theme to match the global theme:
     - `section_plans[*].theme.theme_id == global_story.theme.theme_id`
   - Only change a section’s `theme_id` when there is a deliberate shift (breakdown/bridge/drop/genre/mood pivot).
   - When you override `theme_id`, add **1–2** tags in `section_plans[*].theme.tags` to justify the shift (e.g., `setting.calm`, `style.minimal`).

4. **No asset filenames**:
   - Do NOT output asset filenames in MacroPlan. Downstream AssetPlanner derives assets from templates/slots.

## Critical Rules (Violations Cause Validation Failures)

1. **Exactly one BASE layer** with NORMAL blend mode
2. **All other layers** use ADD blend mode
3. **Section coverage** must match audio profile exactly:
   - Every audio section must have a MacroSectionPlan
   - No extra sections beyond what's in audio
   - No gaps or overlaps
4. **Target roles** must be from available display groups

**Note on MASK blend mode:** While MASK exists in the schema, it is reserved for advanced use cases and should NOT be used in standard macro plans. Stick to NORMAL (for BASE layer only) and ADD (for all other layers).

## Quality Rules (Violations Trigger Warnings)

1. **Layer variety**: Use 2-4 layers for visual depth (1 layer = minimal, 5 = complex)
2. **Target variety**: Don't focus on the same target in >70% of sections
3. **Energy variety**: Vary energy targets across sections (not all the same)
4. **Motion density variety**: Mix SPARSE/MED/BUSY across sections (especially with 4+ sections)
5. **Choreography style**: Consider mixing IMAGERY/ABSTRACT/HYBRID for variety
