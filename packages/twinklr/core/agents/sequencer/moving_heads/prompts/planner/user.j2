Design a choreography plan for the following song:

{% if context.get('metadata') %}
## Song Information

{% if context.metadata.get('artist') and context.metadata.get('title') %}
**Song**: "{{ context.metadata.title }}" by {{ context.metadata.artist }}
{% elif context.metadata.get('title') %}
**Song**: "{{ context.metadata.title }}"
{% elif context.metadata.get('artist') %}
**Artist**: {{ context.metadata.artist }}
{% endif %}
{% if context.metadata.get('genre') %}
**Genre**: {{ context.metadata.genre | join(', ') if context.metadata.genre is iterable and context.metadata.genre is not string else context.metadata.genre }}
{% endif %}

{% endif %}
## Song Context

{{ context.song_structure | tojson(indent=2) }}

## Available Resources

**Fixtures**: {{ context.fixtures.count }} moving heads
**Rig Layout**: {{ context.fixtures.groups | tojson }}

**Template Library** ({{ context.available_templates | length }} templates):
{% for template in context.available_templates %}
- {{ template }}
{% endfor %}

## Beat Grid

- **Tempo**: {{ context.beat_grid.tempo }} BPM
- **Time Signature**: {{ context.beat_grid.time_signature }}
- **Total Bars**: {{ context.beat_grid.total_bars }}

{% if feedback %}
## Feedback from Previous Iteration

{% for item in feedback %}
- {{ item }}
{% endfor %}

Please address the above feedback in your revised plan.
{% endif %}

## Instructions

Create a complete choreography plan that:

1. **Maps to song structure**: Design sequences for each section (intro, verse, chorus, bridge, outro)
2. **Matches energy levels**: Use appropriate template intensities for each section
3. **Creates visual interest**: Vary templates and timing throughout
4. **Maintains flow**: Plan smooth transitions between sections
5. **Uses templates effectively**: Select from available templates (which already define movement, geometry, and dimmer patterns)
6. **Default to 1 per section**: Only split a section into 2–3 segments if there’s a clear musical change within the section.

## Required Output Format

Provide your plan as a JSON object matching this schema:

```json
{{ response_schema }}
```

**CRITICAL REQUIREMENTS**:
1. **Template Selection**: Use ONLY template IDs from the Template Library list above (exactly as written)
2. **Template Composition**: Each template is a complete choreography unit with movement, geometry, and dimmer patterns already configured
3. **Your Job**: For each song section, choose either:
   - **Single-template section**: provide `template_id` (+ optional `preset_id`, `modifiers`) for the entire section bar range. Leave `segments` omitted or set to `null`.
   - **Segmented section**: provide `segments` (1 to 3 items, not null or empty). Each segment must include `segment_id`, `start_bar`, `end_bar`, `template_id` (+ optional `preset_id`, `modifiers`). Leave section-level `template_id` omitted or `null`.
4. **Segmentation Rules** (only if using `segments`):
   - Max **3** segments per section
   - Segments must be **contiguous** and **non-overlapping**
   - Segments must **fully cover** the section range (first segment starts at section `start_bar`, last segment ends at section `end_bar`)
   - Prefer not to create segments shorter than **1 bar**
   - Default is **1 segment**; only split when musically justified (pickup/build/drop/hit/A-B change)
5. **Bar Numbering**: Bar numbers are 1-indexed. First bar is 1, not 0. Use `start_bar >= 1` for all sections
6. **Presets**: Use `preset_id` for variations (CHILL, MODERATE, ENERGETIC, etc.) - optional
