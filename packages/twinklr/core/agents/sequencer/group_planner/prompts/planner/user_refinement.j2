{#
GroupPlanner User Prompt - REFINEMENT ONLY
Used for iteration 2+ to avoid resending full context.
References system prompt rules and existing conversation context.
#}
# Refinement Request: {{ section_name }} ({{ section_id }})

## Iteration {{ iteration + 1 }} Feedback

{{ feedback }}

## Key Reminders

- **Section:** {{ section_name }} ({{ (start_ms / 1000) | round(1) }}s to {{ (end_ms / 1000) | round(1) }}s)
- **Musical Length:** {{ section_duration_bars }} bars ({{ section_duration_beats }} beats) — bars 1-{{ available_bars }}
- **Hard Bar Limit:** bar {{ section_max_bar }}
- **Energy Target:** {{ energy_target }}
- **Primary Targets:** {{ primary_focus_targets | join(", ") }}
{% if section_duration_bars < 1 %}
⚠️ **VERY SHORT SECTION:** Only bar 1 beat 1 with HIT duration. Skip BASE/RHYTHM.
{% elif section_duration_bars < 2 %}
⚠️ **SHORT SECTION:** Use HIT/BURST only.
{% elif section_duration_bars <= 5 %}
⚠️ **BRIEF SECTION:** ONE placement per target per lane — no stacking.
{% endif %}

**Required fields (copy to response):**
{% if theme_ref %}
- **Theme:** {{ theme_ref.theme_id }}{% if theme_ref.tags %} (tags: {{ theme_ref.tags | join(", ") }}){% endif %}, scope={{ theme_ref.scope }}
{% endif %}
{% if palette_ref_json %}
- **Palette:** {{ palette_ref_json }}
{% endif %}
{% if motif_ids %}
- **Motifs:** {{ motif_ids | join(", ") }}
{% endif %}

{% if revision_request %}
## Revision Priority: {{ revision_request.priority }}

{% if revision_request.focus_areas %}
**Focus Areas:** {{ revision_request.focus_areas | join(", ") }}
{% endif %}

{% if revision_request.specific_fixes %}
**Fixes Required:**
{% for fix in revision_request.specific_fixes[:10] %}
- {{ fix }}
{% endfor %}
{% if revision_request.specific_fixes | length > 10 %}
- ... and {{ revision_request.specific_fixes | length - 10 }} more issues
{% endif %}
{% endif %}

{% if revision_request.avoid %}
**Avoid:**
{% for item in revision_request.avoid %}
- {{ item }}
{% endfor %}
{% endif %}
{% endif %}

## Instructions

1. Address ALL ERROR severity issues first
2. Keep working structure — only fix flagged issues
{% if revision_request and revision_request.specific_fixes %}
3. Apply the specific fixes listed above directly where they reference exact template/target/lane changes
{% endif %}
4. Return the complete revised SectionCoordinationPlan
