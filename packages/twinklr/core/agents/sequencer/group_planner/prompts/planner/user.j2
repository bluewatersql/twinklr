{#
GroupPlanner User Prompt - INITIAL PLANNING
Provides full section context for iteration 1.
Refinement iterations (2+) use user_refinement.j2 instead.
#}

# Section Information

**Section ID:** {{ section_id }}
**Section Name:** {{ section_name }}
**Timing:** {{ (start_ms / 1000) | round(1) }}s to {{ (end_ms / 1000) | round(1) }}s ({{ ((end_ms - start_ms) / 1000) | round(1) }}s duration)
**Musical Length:** {{ section_duration_bars }} bars ({{ section_duration_beats }} beats) - you have bars 1 through {{ available_bars }} to work with
{% if section_duration_bars < 1 %}
⚠️ **VERY SHORT SECTION (< 1 bar):** This is a pickup/transition. Use minimal placements:
- ONE accent HIT on primary target at bar 1, beat 1
- Skip BASE and RHYTHM lanes (no time for patterns)
- Do NOT use SECTION duration (section is shorter than 1 bar)
{% elif section_duration_bars < 2 %}
⚠️ **SHORT SECTION (< 2 bars):** Limited space. Use HIT/BURST durations only. Avoid PHRASE/EXTENDED/SECTION.
{% endif %}

## MacroPlan Intent

**Energy Target:** {{ energy_target }}
**Motion Density:** {{ motion_density }}
**Choreography Style:** {{ choreography_style }}

**Primary Focus Targets:** {{ primary_focus_targets | join(", ") }}
{% if secondary_targets %}
**Secondary Targets:** {{ secondary_targets | join(", ") }}
{% endif %}

{% if notes %}
**Section Notes:** {{ notes }}
{% endif %}

## MacroPlan Palette + Motifs (REQUIRED - Copy to Your Response)

{% if palette_ref_json %}
**Resolved Palette for This Section** (COPY THIS EXACTLY to your response):
{{ palette_ref_json }}
{% else %}
**ERROR:** Palette information missing from MacroPlan
{% endif %}

{% if motif_ids %}
**Motif IDs for This Section** (COPY THIS EXACTLY to your response):
{{ motif_ids | join(", ") }}

**Template Selection with Motif Alignment:**
These motifs represent visual themes for this section. Prefer templates with matching affinity tags to enhance variety and thematic coherence:
{% for motif_id in motif_ids %}
- Templates with `motif.{{ motif_id }}` for "{{ motif_id }}"
{% endfor %}

You don't need to match ALL motifs, but aim for good alignment between templates and motifs where it fits the section's energy and intent.

{% else %}
**ERROR:** Motif IDs missing from MacroPlan
{% endif %}

{% if motif_catalog_summary %}
Motif Catalog (summary for reference):
{{ motif_catalog_summary }}
{% endif %}

## Available Display Groups

{% for group in display_graph.groups %}
- **{{ group.group_id }}** (role: {{ group.role }}) - {{ group.display_name }}{% if group.position %} [x={{ group.position.x }}, y={{ group.position.y }}]{% endif %}
{% endfor %}

### Groups by Role
{% for role, group_ids in display_graph.groups_by_role.items() %}
- **{{ role }}**: {{ group_ids | join(", ") }}
{% endfor %}

## Available Templates

### BASE Lane Templates
{% for entry in template_catalog.entries %}
{% if "BASE" in entry.compatible_lanes %}
- `{{ entry.template_id }}` - {{ entry.name }}
  {% if entry.affinity_tags %}- Affinity: {{ entry.affinity_tags | join(", ") }}{% endif %}
  {% if entry.avoid_tags %}- Avoid: {{ entry.avoid_tags | join(", ") }}{% endif %}
  {% if entry.tags %}- Tags: {{ entry.tags | join(", ") }}{% endif %}
{% endif %}
{% endfor %}

### RHYTHM Lane Templates
{% for entry in template_catalog.entries %}
{% if "RHYTHM" in entry.compatible_lanes %}
- `{{ entry.template_id }}` - {{ entry.name }}
  {% if entry.affinity_tags %}- Affinity: {{ entry.affinity_tags | join(", ") }}{% endif %}
  {% if entry.avoid_tags %}- Avoid: {{ entry.avoid_tags | join(", ") }}{% endif %}
  {% if entry.tags %}- Tags: {{ entry.tags | join(", ") }}{% endif %}
{% endif %}
{% endfor %}

### ACCENT Lane Templates
{% for entry in template_catalog.entries %}
{% if "ACCENT" in entry.compatible_lanes %}
- `{{ entry.template_id }}` - {{ entry.name }}
  {% if entry.affinity_tags %}- Affinity: {{ entry.affinity_tags | join(", ") }}{% endif %}
  {% if entry.avoid_tags %}- Avoid: {{ entry.avoid_tags | join(", ") }}{% endif %}
  {% if entry.tags %}- Tags: {{ entry.tags | join(", ") }}{% endif %}
{% endif %}
{% endfor %}

{% if layer_intents %}
## Layer Intent (from MacroPlan)

{% for layer in layer_intents %}
**Layer {{ layer.layer_index }}: {{ layer.layer_role }}**
- Targets: {{ layer.target_selector.roles | join(", ") }}
- Coordination: {{ layer.target_selector.coordination }}
- Timing Driver: {{ layer.timing_driver }}
- Intensity Bias: {{ layer.intensity_bias }}
{% if layer.usage_notes %}
- Notes: {{ layer.usage_notes }}
{% endif %}

{% endfor %}
{% endif %}

## Theme Context (from MacroPlan)

**ThemeRef for This Section** (COPY THIS EXACTLY to your response):
{{ theme_ref_json }}

**CRITICAL:** You MUST include this exact theme, palette, and motif_ids in your SectionCoordinationPlan response. Do not use placeholders like "MISSING" or leave these fields empty.

Theme defaults (for reference only):
- default_tags: {{ theme_definition.default_tags | join(", ") }}
- style_tags: {{ theme_definition.style_tags | join(", ") }}
- avoid_tags: {{ theme_definition.avoid_tags | join(", ") }}
- default_palette_id: {{ theme_definition.default_palette_id }}

# Your Task

Create a SectionCoordinationPlan for **{{ section_name }} ({{ section_id }})**.

**Follow the {{ energy_target }} ENERGY RECIPE from the system prompt:**
{% if energy_target == "HIGH" %}
- BASE: SOFT intensity, SECTION duration (OUTLINE + WINDOWS)
- RHYTHM: SEQUENCED mode, STRONG intensity (ARCHES or similar)
- ACCENT: PEAK on 1 HERO, STRONG on others, HIT/BURST duration, stagger timing
{% elif energy_target == "LOW" %}
- BASE: WHISPER-SOFT intensity, SECTION duration
- RHYTHM: Optional, SOFT intensity if used
- ACCENT: Optional, MED intensity maximum, HIT only
{% else %}
- BASE: SOFT intensity, SECTION duration
- RHYTHM: MED-STRONG intensity, PHRASE duration
- ACCENT: STRONG intensity (not PEAK), BURST duration, stagger by 2+ beats
{% endif %}

**COPY THESE EXACTLY to your response:**
- theme: (from ThemeRef above)
- palette: (from Palette above)
- motif_ids: [{{ motif_ids | join(", ") }}]

**Primary targets for ACCENT:** {{ primary_focus_targets | join(", ") }}
**Available bars:** 1 to {{ available_bars }}
