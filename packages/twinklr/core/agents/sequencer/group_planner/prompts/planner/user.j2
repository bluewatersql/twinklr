{#
GroupPlanner User Prompt - INITIAL PLANNING
Provides section-specific context for iteration 1.
Refinement iterations (2+) use user_refinement.j2 instead.
Rules and energy recipes live in system.j2 — NOT restated here.
#}

# Section Information

**Section ID:** {{ section_id }}
**Section Name:** {{ section_name }}
**Timing:** {{ (start_ms / 1000) | round(1) }}s to {{ (end_ms / 1000) | round(1) }}s ({{ ((end_ms - start_ms) / 1000) | round(1) }}s duration)
**Musical Length:** {{ section_duration_bars }} bars ({{ section_duration_beats }} beats) — bars 1 through {{ available_bars }}
**Hard Bar Limit:** `section_max_bar = {{ section_max_bar }}` (all starts and window ends must be <= this bar)
{% if section_duration_bars < 1 %}
⚠️ **VERY SHORT SECTION (< 1 bar):** This is a pickup/transition. Use minimal placements:
- ONE accent HIT on primary target at bar 1, beat 1
- Skip BASE and RHYTHM lanes (no time for patterns)
- Do NOT use SECTION duration (section is shorter than 1 bar)
{% elif section_duration_bars < 2 %}
⚠️ **SHORT SECTION (< 2 bars):** Limited space. Use HIT/BURST durations only. Avoid PHRASE/EXTENDED/SECTION.
{% elif section_duration_bars <= 5 %}
⚠️ **BRIEF SECTION (≤ 5 bars):** Keep it simple — ONE placement per target per lane. HIT/BURST preferred.
{% endif %}

## MacroPlan Intent

**Energy Target:** {{ energy_target }}
**Motion Density:** {{ motion_density }}
**Choreography Style:** {{ choreography_style }}

**Primary Focus Targets:** {{ primary_focus_targets | join(", ") }}
{% if secondary_targets %}
**Secondary Targets:** {{ secondary_targets | join(", ") }}
{% endif %}

{% if notes %}
**Section Notes:** {{ notes }}
{% endif %}

## Theme + Palette + Motifs (REQUIRED — Copy Exactly to Response)

{% if theme_ref_json %}
**ThemeRef:**
{{ theme_ref_json }}
{% else %}
**ERROR:** Theme information missing from MacroPlan
{% endif %}

{% if palette_ref_json %}
**Palette:**
{{ palette_ref_json }}
{% else %}
**ERROR:** Palette information missing from MacroPlan
{% endif %}

{% if motif_ids %}
**Motif IDs:** {{ motif_ids | join(", ") }}

Prefer templates with matching `motif.*` affinity tags to enhance variety and thematic coherence.
{% else %}
**ERROR:** Motif IDs missing from MacroPlan
{% endif %}

{% if motif_catalog_summary %}
Motif Catalog (reference):
{{ motif_catalog_summary }}
{% endif %}

## Available Display Groups

{% for group in display_graph.groups %}
- **{{ group.id }}** (role: {{ group.role }}){% if group.element_kind is defined and group.element_kind %} [{{ group.element_kind }}]{% endif %}, {{ group.fixture_count }} model{{ "s" if group.fixture_count != 1 else "" }}{% if group.pixel_fraction is defined and group.pixel_fraction > 0 %}, {{ (group.pixel_fraction * 100) | round(0) | int }}% of display{% endif %}{% if group.prominence is defined and group.prominence %} ({{ group.prominence }}){% endif %} detail: {{ group.detail_capability }}{% if group.tags is defined and group.tags %} zones: {{ group.tags | join(", ") }}{% endif %}{% if group.split_membership is defined and group.split_membership %} splits: {{ group.split_membership | join(", ") }}{% endif %}

{% if (group.position is defined and group.position) or (group.arrangement is defined and group.arrangement) %}  Layout: {% if group.arrangement is defined and group.arrangement %}{{ group.arrangement }}{% endif %}{% if group.position is defined and group.position %}{% if group.position.horizontal is defined %} — {{ group.position.horizontal }}{% endif %}{% if group.position.vertical is defined %} / {{ group.position.vertical }}{% endif %}{% if group.position.depth is defined and group.position.depth != "NEAR" %} / {{ group.position.depth }}{% endif %}{% if group.position.zone is defined and group.position.zone %} [{{ group.position.zone }}]{% endif %}{% endif %}

{% endif %}
{% endfor %}

### Groups by Role
{% for role, group_ids in display_graph.groups_by_role.items() %}
- **{{ role }}**: {{ group_ids | join(", ") }}
{% endfor %}

{% if display_graph_zones %}
### Zone Map (target type: "zone")
{% for zone_entry in display_graph_zones %}
- **{{ zone_entry.zone }}**: {{ zone_entry.group_ids | join(", ") }}
{% endfor %}
{% endif %}

{% if display_graph_splits %}
### Available Splits (target type: "split")
{% for split_name, split_groups in display_graph_splits.items() %}
- **{{ split_name }}**: {{ split_groups | join(", ") }}
{% endfor %}
{% endif %}

{% if display_graph_spatial and display_graph_spatial.horizontal %}
### Spatial Layout (left → right)
{% for entry in display_graph_spatial.horizontal %}
- {{ entry.position }}: **{{ entry.id }}** ({{ entry.role }}, detail: {{ entry.detail }})
{% endfor %}
{% endif %}

## Available Templates

**CRITICAL:** Each template belongs to exactly ONE lane. Only use templates under the lane they are listed below.

### BASE Lane Templates (use ONLY in BASE lane)
{% for entry in template_catalog.entries %}
{% if "BASE" in entry.compatible_lanes %}
- `{{ entry.template_id }}` - {{ entry.name }}
  {% if entry.affinity_tags %}- Affinity: {{ entry.affinity_tags | join(", ") }}{% endif %}
  {% if entry.tags %}- Tags: {{ entry.tags | join(", ") }}{% endif %}
{% endif %}
{% endfor %}

### RHYTHM Lane Templates (use ONLY in RHYTHM lane)
{% for entry in template_catalog.entries %}
{% if "RHYTHM" in entry.compatible_lanes %}
- `{{ entry.template_id }}` - {{ entry.name }}
  {% if entry.affinity_tags %}- Affinity: {{ entry.affinity_tags | join(", ") }}{% endif %}
  {% if entry.tags %}- Tags: {{ entry.tags | join(", ") }}{% endif %}
{% endif %}
{% endfor %}

### ACCENT Lane Templates (use ONLY in ACCENT lane)
{% for entry in template_catalog.entries %}
{% if "ACCENT" in entry.compatible_lanes %}
- `{{ entry.template_id }}` - {{ entry.name }}
  {% if entry.affinity_tags %}- Affinity: {{ entry.affinity_tags | join(", ") }}{% endif %}
  {% if entry.tags %}- Tags: {{ entry.tags | join(", ") }}{% endif %}
{% endif %}
{% endfor %}

{% if layer_intents %}
## Layer Intent (from MacroPlan)

{% for layer in layer_intents %}
**Layer {{ layer.layer_index }}: {{ layer.layer_role }}**
- Targets: {{ layer.target_selector.roles | join(", ") }}
- Coordination: {{ layer.target_selector.coordination }}
- Timing Driver: {{ layer.timing_driver }}
- Intensity Bias: {{ layer.intensity_bias }}
{% if layer.usage_notes %}
- Notes: {{ layer.usage_notes }}
{% endif %}

{% endfor %}
{% endif %}

## Multi-Lane Reuse Allowlist

{% if multilane_allowed_groups %}
These groups may appear in both RHYTHM and ACCENT: {{ multilane_allowed_groups | join(", ") }}
(See system prompt Rule #2 for override semantics.)
{% else %}
No allowlist — each target must appear in exactly one lane.
{% endif %}

{% if lyric_context %}
## Narrative Context (from Lyrics Analysis)

{% if lyric_context.has_narrative %}**This song has a clear narrative.** Characters: {{ lyric_context.characters | join(", ") }}{% endif %}
**Themes:** {{ lyric_context.themes | join(", ") }}
**Mood Arc:** {{ lyric_context.mood_arc }}

{% if lyric_context.story_beats %}
### Story Beats for This Section
{% for beat in lyric_context.story_beats %}
- **[{{ beat.beat_type }}]** {{ beat.description }}
  - Visual opportunity: {{ beat.visual_opportunity }}
{% endfor %}
{% endif %}

{% if lyric_context.key_phrases %}
### Key Lyric Phrases for This Section
{% for phrase in lyric_context.key_phrases %}
- "{{ phrase.text }}" [{{ phrase.emphasis }}] — {{ phrase.visual_hint }}
{% endfor %}
{% endif %}
{% endif %}

{% if color_arc or propensity_hints or style_constraints %}
## Feature Engineering Context

{% if color_arc %}
### Color Arc
- **Palette:** {{ color_arc.palette_id | default('-') }}
- **Shift Timing:** {{ color_arc.shift_timing | default('-') }}
- **Contrast Target:** {{ color_arc.contrast_target | default('-') }}
{% endif %}

{% if propensity_hints %}
### Propensity Hints
{% for aff in propensity_hints.affinities[:5] %}
- **{{ aff.effect_family }}** on {{ aff.model_type }}: frequency={{ aff.frequency }}
{% endfor %}
{% endif %}

{% if style_constraints %}
### Style Constraints
{% if style_constraints.timing_style %}
- Beat alignment: {{ style_constraints.timing_style.beat_alignment_strictness | default('-') }}
- Density: {{ style_constraints.timing_style.density_preference | default('-') }}
{% endif %}
{% endif %}

{% endif %}

# Your Task

Create a SectionCoordinationPlan for **{{ section_name }} ({{ section_id }})**.

**Follow the {{ energy_target }} ENERGY RECIPE from the system prompt.**
**Copy theme, palette, and motif_ids exactly from above.**
**Primary targets for ACCENT:** {{ primary_focus_targets | join(", ") }}
**Available bars:** 1 to {{ available_bars }} (hard limit: bar {{ section_max_bar }})

{% if lyric_context %}
**NARRATIVE ASSETS:** Include `narrative_assets` with 1-10 figurative imagery directives based on the narrative context above.
{% else %}
**NARRATIVE ASSETS:** No lyric context — set `narrative_assets` to `[]`.
{% endif %}
