{#
GroupPlanner Developer Prompt
Technical constraints and enum guidance
#}
## Technical Constraints

**Schema Version:** section-coordination-plan.v1
**Max Lanes:** 3 (BASE, RHYTHM, ACCENT)
**Max Coordination Plans per Lane:** 10
**Max Groups per Coordination Plan:** 20

### Intensity Limits (STRICT - Exceeding will fail validation)

| Lane   | Max Intensity | Typical Range | Purpose |
|--------|--------------|---------------|---------|
| BASE   | **1.10**     | 0.60-0.90     | Foundation, never dominate |
| RHYTHM | **1.20**     | 0.80-1.05     | Motion, support layers |
| ACCENT | **1.30**     | 0.95-1.20     | Highlights, don't overpower |

**WARNING:** Values exceeding lane max will FAIL validation. Never use intensity >1.30 on ACCENT lane.

## Response Schema

You must return a `SectionCoordinationPlan` that matches this JSON schema:

```json
{{ response_schema }}
```

## Enum Values (Use These Exactly)

{% if taxonomy %}
**LaneKind:** {{ taxonomy.LaneKind | join(', ') }}
**CoordinationMode:** {{ taxonomy.CoordinationMode | join(', ') }}
**StepUnit:** {{ taxonomy.StepUnit | join(', ') }}
**SpillPolicy:** {{ taxonomy.SpillPolicy | join(', ') }}
{% else %}
{# Fallback if taxonomy not provided #}
**LaneKind:** BASE, RHYTHM, ACCENT
**CoordinationMode:** UNIFIED, COMPLEMENTARY, SEQUENCED, CALL_RESPONSE, RIPPLE
**StepUnit:** BEATS, BARS, MS
**SpillPolicy:** NONE, OVERLAP, BLEND
{% endif %}

## Critical Rules

1. **Template-Lane Compatibility**:
   - BASE templates → BASE lane only
   - RHYTHM templates → RHYTHM lane only
   - ACCENT templates → ACCENT lane only
   - Check `compatible_lanes` field in template catalog

2. **No Within-Lane Overlaps**:
   - Same group cannot appear in multiple coordination_plans in same lane with overlapping timing
   - Cross-lane overlaps are allowed (different lanes can use same groups simultaneously)

3. **Group Order Validation** (for SEQUENCED/CALL_RESPONSE/RIPPLE modes):
   - No duplicates in group_order array
   - All groups in group_order must be in group_ids
   - Order determines execution sequence

4. **Timing Constraints**:
   - All placements must be within section bounds (start_ms to end_ms)
   - Window ranges must be within section bounds
   - No negative durations

5. **Intensity Constraints** (STRICT):
   - BASE lane: Max 1.10 (typical 0.6-0.9, foundation only)
   - RHYTHM lane: Max 1.20 (typical 0.8-1.05, motion support)
   - ACCENT lane: Max 1.30 (typical 0.95-1.20, highlights)
   - **Exceeding lane max = VALIDATION FAILURE**
   - For "peak" moments: Use 1.20-1.28 on ACCENT, never >1.30

## Template Catalog Reference

Available templates are provided in `template_catalog`. Each entry shows:
- `template_id`: Unique identifier
- `name`: Descriptive name
- `compatible_lanes`: Which lanes can use this template
- `affinity_tags`: Theme/style tags this template works well with
- `avoid_tags`: Theme/style tags this template should avoid
- `tags`: Template characteristics (e.g., "sweep", "static", "movement")

**Template Selection Guidelines:**
- Always check `compatible_lanes` before assigning templates to lanes
- Match `affinity_tags` with theme tags when possible for better coherence
- Avoid templates whose `avoid_tags` conflict with the section theme
- Use affinity tags to guide template selection based on visual intent

## Theme Rules (NEW)

1. **You must set `theme` at the top level of the SectionCoordinationPlan**:
   - `theme.theme_id` must be a stable id (no prose).
   - `theme.scope` must be `SECTION`.

2. **Theme tags are limited**:
   - `theme.tags`: 0-5 items max.
   - Prefer 0–2 tags; use 3–5 only when necessary.
   - Use tags only to refine the theme (e.g., "setting.snowy_night", "motif.candy_trim").

3. **Template-theme coherence**:
   - Prefer templates whose `affinity_tags` match the theme's tags.
   - Avoid templates whose `avoid_tags` conflict with the theme's tags.
   - This ensures visual and stylistic consistency across the section.

## Palette + Motifs (Hard Requirements)

- **Palette**:
  - Set `palette` on the SectionCoordinationPlan as a PaletteRef.
  - Use MacroPlan section override if present, else inherit MacroPlan global primary palette.
  - Do not invent palette_id values.

- **Motifs**:
  - Copy MacroPlan section `motif_ids` into the SectionCoordinationPlan.
  - Ensure template selections across lanes include motif coverage:
    - At least one selected template has tags that match one of the section’s motif tags (`motif.*`).
  - Do not invent motif_ids.

## Recurring Soft-Fail Patterns (Address These Proactively)

These issues cause ~80% of first-iteration failures. Avoid them:

### 1. Identical Accents on All Primary Targets (VARIETY)
- Stagger timing by 1+ beat OR vary template/intensity on at least one primary target.

### 2. Layer Imbalance (LAYERING)
- Keep intensity hierarchy: BASE < RHYTHM < ACCENT within lane limits.

### 3. Timing Driver Mismatch (TIMING)
- Match timing_driver to placement snap rules (BEATS/BARS vs LYRICS).
