{#
GroupPlanner Developer Prompt - SCHEMA & TECHNICAL FORMAT ONLY
Rules live in system.j2. This prompt covers response format, enum values,
targeting mechanics, and mode examples.
#}
{% if learning_context %}
## Common Patterns to Watch

{{ learning_context }}

---
{% endif %}

## Response Schema

Return a `SectionCoordinationPlan` matching this schema:

```json
{{ response_schema }}
```

## Enum Values (Use Exactly)

{% if taxonomy %}
- **LaneKind:** {{ taxonomy.LaneKind | join(', ') }}
- **CoordinationMode:** {{ taxonomy.CoordinationMode | join(', ') }}
- **IntensityLevel:** {{ taxonomy.IntensityLevel | join(', ') }}
- **EffectDuration:** {{ taxonomy.EffectDuration | join(', ') }}
- **StepUnit:** {{ taxonomy.StepUnit | join(', ') }}
- **TargetType:** {{ taxonomy.TargetType | join(', ') }}
- **SplitDimension:** {{ taxonomy.SplitDimension | join(', ') }}
- **DetailCapability:** {{ taxonomy.DetailCapability | join(', ') }}
{% else %}
- **LaneKind:** BASE, RHYTHM, ACCENT
- **CoordinationMode:** UNIFIED, COMPLEMENTARY, SEQUENCED, CALL_RESPONSE, RIPPLE
- **IntensityLevel:** WHISPER, SOFT, MED, STRONG, PEAK
- **EffectDuration:** HIT, BURST, PHRASE, EXTENDED, SECTION
- **StepUnit:** BEATS, BARS
- **TargetType:** group, zone, split
- **SplitDimension:** HALVES_LEFT, HALVES_RIGHT, THIRDS_LEFT, THIRDS_CENTER, THIRDS_RIGHT, ODD, EVEN
- **DetailCapability:** LOW, MEDIUM, HIGH
{% endif %}

**IMPORTANT:** Valid group target IDs are the exact `ChoreoGroup.id` values listed in the display graph (user prompt), NOT role names. Zone IDs are ChoreoTag values. Split IDs are SplitDimension values above.

## Targeting System

Use typed targets to specify what each coordination plan affects:

| Type | id is | Example | Resolves To |
|------|-------|---------|-------------|
| `group` | ChoreoGroup.id | `{"type": "group", "id": "ARCHES"}` | That specific group |
| `zone` | ChoreoTag value | `{"type": "zone", "id": "HOUSE"}` | All groups tagged with HOUSE |
| `split` | SplitDimension value | `{"type": "split", "id": "HALVES_LEFT"}` | All groups with HALVES_LEFT membership |

- Targets go in `coordination_plan.targets[]` (list of typed objects).
- Placements also have a `target` field (single typed object).
- The renderer resolves zone/split targets to concrete groups at composition time.
- **Different targets may overlap** in the same lane — the renderer blends them.
- **The SAME target must NOT overlap itself** in the same lane.

## Detail Capability (Template Suitability)

- **HIGH** (matrices, mega trees): Any template, including imagery and complex patterns
- **MEDIUM** (arches, wreaths, window frames): Patterns, gradients, moderate complexity
- **LOW** (candy canes, snowflakes, stars): Simple chases, solid colors, basic on/off

## Mode Examples

### SEQUENCED Mode

```json
{
  "coordination_mode": "SEQUENCED",
  "targets": [{"type": "group", "id": "ARCHES"}, {"type": "group", "id": "CANDY_CANES"}],
  "window": {
    "template_id": "gtpl_rhythm_chase_single",
    "start": {"bar": 1, "beat": 1},
    "end": {"bar": 4, "beat": 1},
    "intensity": "STRONG"
  },
  "config": {
    "group_order": ["ARCHES", "CANDY_CANES"],
    "step_unit": "BEATS",
    "step_duration": 2
  }
}
```

### UNIFIED Mode — Zone Target

```json
{
  "coordination_mode": "UNIFIED",
  "targets": [{"type": "zone", "id": "HOUSE"}],
  "placements": [
    {
      "placement_id": "base_house_glow",
      "target": {"type": "zone", "id": "HOUSE"},
      "template_id": "gtpl_base_glow_warm",
      "start": {"bar": 1, "beat": 1},
      "duration": "SECTION",
      "intensity": "SOFT"
    }
  ]
}
```

### CALL_RESPONSE Mode — Split Targets

```json
{
  "coordination_mode": "CALL_RESPONSE",
  "targets": [{"type": "split", "id": "ODD"}, {"type": "split", "id": "EVEN"}],
  "window": {
    "template_id": "gtpl_rhythm_pulse_even",
    "start": {"bar": 1, "beat": 1},
    "end": {"bar": 4, "beat": 1},
    "intensity": "STRONG"
  },
  "config": {
    "group_order": ["ODD", "EVEN"],
    "step_unit": "BEATS",
    "step_duration": 2
  }
}
```

## Timing Format

```json
{"bar": 1, "beat": 1}  // Section-relative (bar 1 = section start)
```

- Bars: 1 to available_bars (see user prompt)
- Beats: 1 to 4 (assuming 4/4)

**No extra fields:** Do not output keys not present in the response schema. Specifically: `lane_plans[*]` must NOT include `planning_notes`.

{% if recipe_catalog and recipe_catalog.entries %}
## Template Catalog (Includes Recipes)

Some entries in the template catalog are multi-layer composite recipes from feature engineering analysis. Prefer recipes with high model affinity for the target groups.

| recipe_id | name | type | layers | effect_types | model_affinities |
|-----------|------|------|--------|--------------|------------------|
{% for r in recipe_catalog.entries -%}
| {{ r.recipe_id }} | {{ r.name }} | {{ r.template_type }} | {{ r.layer_count }} | {{ r.effect_types | join(', ') }} | {% for a in r.model_affinities %}{{ a.model_type }}={{ a.score }}{% if not loop.last %}, {% endif %}{% endfor %} |
{% endfor %}
Recipe IDs are valid `template_id` values. The renderer handles multi-layer composition.
{% endif %}
