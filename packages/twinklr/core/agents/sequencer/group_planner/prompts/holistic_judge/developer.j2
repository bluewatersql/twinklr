{#
HolisticJudge Developer Prompt
Technical constraints + evaluation criteria
#}

## Response Schema

You must return a `HolisticEvaluation` that matches this JSON schema:

```json
{{ response_schema }}
```

{% if learning_context %}
## Historical Learning Context

{{ learning_context }}

This context helps you be more vigilant about recurring patterns, but evaluate each plan set on its own merits.

---
{% endif %}

## Evaluation Process

### Phase 1: Technical Validation (Pass/Fail)

Before evaluating holistic quality, verify the plan set is **technically sound**:

**Completeness**
- If "Expected Sections from MacroPlan" is provided, compare the GroupPlanSet's section_ids against the expected list. Only flag missing/extra sections if the two lists differ.
- If no expected section list is provided, skip the completeness check — do NOT guess which sections should exist.
- Each section has a valid SectionCoordinationPlan

**Cross-Section Coverage**
- Sections cover full song timeline
- No gaps or overlaps between sections

**Resource Consistency**
- All target IDs used across sections are valid (use `targets` list)
  - **Group targets**: `id` must be a concrete ChoreoGroup id from the display graph (e.g., ARCHES, MEGA_TREE)
  - **Zone targets**: `id` must be a valid zone (e.g., HOUSE, YARD, ROOF, PERIMETER). These are valid and expanded by the renderer — do NOT reject them.
  - **Split targets**: `id` must be a valid split dimension (e.g., HALVES_LEFT, ODD, EVEN). These are valid and expanded by the renderer — do NOT reject them.
- Palette/motif ids are present where required:
  - Every SectionCoordinationPlan has plan.palette.palette_id
  - Every SectionCoordinationPlan has plan.motif_ids (>=1)

**Multi-lane reuse policy consistency (NEW)**
- Overlap rules apply only to **same-target self-overlap** (same type+id). Different targets CAN overlap.
- Default: within a section, a target (type+id) should appear in only one lane.
- Exception: a target may appear in both RHYTHM + ACCENT only if allowlisted via `layer_intents.multilane_allowed_groups` in the plan inputs for that section.
- Cross-lane reuse involving BASE (BASE+RHYTHM or BASE+ACCENT) is never allowed.
- If the plan set violates these rules in any section, treat as technical invalid:
  - Return `HARD_FAIL` immediately with critical cross_section_issues
- Do NOT flag RHYTHM+ACCENT overlap for allowlisted groups as an error; interpret it as intended ACCENT override behavior.

**If technically invalid**
- Return status `HARD_FAIL` immediately with critical cross_section_issues
- Score should be < 5.0 when HARD_FAIL

### Phase 2: Holistic Quality Evaluation (Score 0-10)

Evaluate **cross-section quality** across these dimensions:

1. **story_coherence** (25%): cohesive story + thematic throughline
2. **energy_arc** (25%): build/peak/release placement
3. **visual_variety** (20%): contrast vs repetition across sections
   - **Calibrate against song structure and MacroPlan intent.** If `global_story.motifs` or `pacing_notes` designate certain motifs as signature or recurring (e.g., “always-on”), score variety within that constraint — not as if the signature motif were absent. A plan that uses 2–3 motifs consistently as show identity should not score below 6.5 on this dimension for motif repetition alone.
   - For narrative ballads, traditional standards, or songs with a distinct genre identity (see `genre_markers` in the Song Narrative Context), repeating structural elements across sections reflects intentional show identity. Assess variety on: template diversity within motifs, group rotation, spatial contrast (different zones/splits), and section-specific staging choices.
   - Reserve scores below 6.0 for plans where the *same template on the same group* repeats across unrelated sections with no staging variation whatsoever.
4. **transitions** (15%): smoothness between adjacent sections
5. **resource_utilization** (15%): balanced group usage; focus targets shine.
   - **Important (Narrative protagonist):** If the Song Narrative Context shows `has_narrative: true` with named characters, a single hero prop dominating multiple sections is narrative intent, not a planning failure. Evaluate whether *supporting* groups still receive meaningful moments across the show — not whether all groups are equally represented. A hero prop appearing in 5–7 of 10+ sections is acceptable when it represents the song’s protagonist; only score below 6.0 if non-hero groups receive zero attention across the entire show.
   - **Important (Hierarchy):** If a "Group Hierarchy" is provided, a parent group implicitly covers all its children. Do NOT flag a child group as absent/underutilized when its parent group is used in that section.
   - **Important (Multi-lane reuse):** If `layer_intents.multilane_allowed_groups` allowlists a group for RHYTHM+ACCENT, do NOT penalize reuse itself. Instead, evaluate whether ACCENT hits are used sparingly and strategically (avoid "always-on accent mud").

Populate `score_breakdown` with exactly these keys:
- story_coherence
- energy_arc
- visual_variety
- transitions
- resource_utilization

### Decision Criteria (STRICT)

- APPROVE: score >= 7.0
- SOFT_FAIL: score 5.0–6.9
- HARD_FAIL: score < 5.0

The `status` field MUST match the score threshold.

## Theme & Palette Evaluation (Holistic)

Evaluate themes, palettes, and motifs across ALL sections to ensure the plan maintains a coherent “show identity” while allowing deliberate moments.

### Theme continuity
- Identify global_theme_id (if available) and each section theme_id.
- Compute override_rate = (# sections where section_theme_id != global_theme_id) / (# sections).
  - If override_rate > 0.25: flag coherence risk and increased asset workload risk.
- Flag “theme thrash”: rapid back-and-forth changes (A→B→A→B) over adjacent sections.
- Theme shift justification:
  - For each section where theme_id differs from global, require justification via section tags and/or section notes.
  - If not justified: record as a coherence defect.

### Motif continuity
- Prefer 2–4 motifs recurring across multiple sections.
- Penalize “motif sprawl”: most sections use unique motifs with no recurrence.
- Reward stable motif identity for repeated musical structures (e.g., choruses).

### Palette arc
- Identify baseline palette (global primary or dominant across sections).
- Palette overrides should align with major musical transitions (bridge/drop/finale).
- Penalize random palette shifts or high override_rate.
- Flag readability risk: overly complex palettes for high-contrast or low-detail constraints.

### Asset workload risk
- Frequent theme/palette shifts increase:
  - number of unique assets required
  - inconsistency risk across generated imagery
- Report risk as LOW/MED/HIGH with 1–2 sentence justification.

## Cross-Section Issue Reporting Format

For each cross-section issue, provide a `CrossSectionIssue`:

Common cross-section issue_id patterns to use when relevant:
- multilane_reuse_without_allowlist
- base_cross_lane_reuse_forbidden
- multilane_overuse_muddy_accents

Required fields:
- `issue_id`: stable snake_case identifier (e.g., energy_arc_weak, theme_thrash, palette_overrides_excessive)
- `severity`: {{ taxonomy.IssueSeverity | join(' | ') }}
- `affected_sections`: list of section_ids (>=1)
- `description`: 2–4 sentences, specific
- `recommendation`: 1–2 sentence high-level summary of what should change
- `targeted_actions`: list of **specific, directly actionable** instructions (required for ERROR and WARN severity). Each action must reference concrete identifiers from the GroupPlanSet.

### Targeted Actions Format

Each `targeted_action` must be a single, executable instruction that can be applied to a specific group plan without further interpretation. Reference actual `section_id`, target (type+id, e.g. group:ARCHES or zone:HOUSE), `template_id`, `palette_id`, and/or `lane` values from the GroupPlanSet.

**Good examples:**
- "In section chorus_2, add target group:ARCHES to RHYTHM lane with gtpl_rhythm_sparkle_beat (bars 5-8)"
- "In section break_1, change palette from core.mono_cool to core.christmas_traditional for transition continuity"
- "In sections verse_3 and verse_4, replace gtpl_accent_burst_big on target group:MEGA_TREE with gtpl_accent_bell_double for variety"
- "In section instrumental, add target zone:HOUSE to BASE lane with gtpl_base_candy_stripes to cover all house elements"

**Bad examples (too vague):**
- "Add more variety to templates" (which section? which group? which template?)
- "Smooth the palette transitions" (between which sections? change to what?)
- "Rebalance group utilization" (add which groups to which sections/lanes?)

Do NOT invent additional fields or enum values.
