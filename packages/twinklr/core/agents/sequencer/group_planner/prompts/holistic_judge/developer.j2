{#
HolisticJudge Developer Prompt
Technical constraints + evaluation criteria
#}

## Response Schema

You must return a `HolisticEvaluation` that matches this JSON schema:

```json
{{ response_schema }}
```

{% if learning_context %}
## Historical Learning Context

{{ learning_context }}

This context helps you be more vigilant about recurring patterns, but evaluate each plan set on its own merits.

---
{% endif %}

## Evaluation Process

### Phase 1: Technical Validation (Pass/Fail)

Before evaluating holistic quality, verify the plan set is **technically sound**:

**Completeness (PRE-VERIFIED)**
- Section completeness has been verified deterministically before this evaluation.
- The "Section Completeness (Pre-Verified)" block in the input shows the result.
- **Trust this result.** Do NOT re-count or re-compare sections against the JSON payload.
- If status is PASSED: all expected sections are present — move on.
- If status is FAILED: use the reported missing/extra sections as-is.
- If status is SKIPPED: no expected list was provided — do not guess.

**Resource Consistency**
- All target IDs used across sections are valid (use `targets` list)
  - **Group targets**: `id` must be a concrete ChoreoGroup id from the display graph (e.g., ARCHES, MEGA_TREE)
  - **Zone targets**: `id` must be a valid zone (e.g., HOUSE, YARD, ROOF, PERIMETER). These are valid and expanded by the renderer — do NOT reject them.
  - **Split targets**: `id` must be a valid split dimension (e.g., HALVES_LEFT, ODD, EVEN). These are valid and expanded by the renderer — do NOT reject them.
- Palette/motif ids are present where required:
  - Every SectionCoordinationPlan has plan.palette.palette_id
  - Every SectionCoordinationPlan has plan.motif_ids (>=1)

**If technically invalid**
- Return status `HARD_FAIL` immediately with critical cross_section_issues
- Score should be < 5.0 when HARD_FAIL

### Phase 2: Holistic Quality Evaluation (Score 0-10)

Evaluate **cross-section quality** across these dimensions:

1. **story_coherence** (25%): cohesive story + thematic throughline
2. **energy_arc** (25%): build/peak/release placement
3. **visual_variety** (20%): contrast vs repetition across sections
   - **Calibrate against song structure and MacroPlan intent.** If `global_story.motifs` or `pacing_notes` designate certain motifs as signature or recurring (e.g., “always-on”), score variety within that constraint — not as if the signature motif were absent. A plan that uses 2–3 motifs consistently as show identity should not score below 6.5 on this dimension for motif repetition alone.
   - For narrative ballads, traditional standards, or songs with a distinct genre identity (see `genre_markers` in the Song Narrative Context), repeating structural elements across sections reflects intentional show identity. Assess variety on: template diversity within motifs, group rotation, spatial contrast (different zones/splits), and section-specific staging choices.
   - Reserve scores below 6.0 for plans where the *same template on the same group* repeats across unrelated sections with no staging variation whatsoever.
4. **transitions** (15%): smoothness between adjacent sections
5. **resource_utilization** (15%): balanced group usage; focus targets shine.
   - **Important (Narrative protagonist):** If the Song Narrative Context shows `has_narrative: true` with named characters, a single hero prop dominating multiple sections is narrative intent, not a planning failure. Evaluate whether *supporting* groups still receive meaningful moments across the show — not whether all groups are equally represented. A hero prop appearing in 5–7 of 10+ sections is acceptable when it represents the song’s protagonist; only score below 6.0 if non-hero groups receive zero attention across the entire show.
   - **Important (Hierarchy):** If a "Group Hierarchy" is provided, a parent group implicitly covers all its children. Do NOT flag a child group as absent/underutilized when its parent group is used in that section.
Populate `score_breakdown` with exactly these keys:
- story_coherence
- energy_arc
- visual_variety
- transitions
- resource_utilization

### Decision Criteria (STRICT)

- APPROVE: score >= 7.0
- SOFT_FAIL: score 5.0–6.9
- HARD_FAIL: score < 5.0

The `status` field MUST match the score threshold.

## Theme & Palette Evaluation (Holistic)

Evaluate themes, palettes, and motifs across ALL sections to ensure the plan maintains a coherent “show identity” while allowing deliberate moments.

### Theme continuity
- Identify global_theme_id (if available) and each section theme_id.
- Compute override_rate = (# sections where section_theme_id != global_theme_id) / (# sections).
  - If override_rate > 0.25: flag coherence risk and increased asset workload risk.
- Flag “theme thrash”: rapid back-and-forth changes (A→B→A→B) over adjacent sections.
- Theme shift justification:
  - For each section where theme_id differs from global, require justification via section tags and/or section notes.
  - If not justified: record as a coherence defect.

### Motif continuity
- Prefer 2–4 motifs recurring across multiple sections.
- Penalize “motif sprawl”: most sections use unique motifs with no recurrence.
- Reward stable motif identity for repeated musical structures (e.g., choruses).

### Palette arc
- Identify baseline palette (global primary or dominant across sections).
- Palette overrides should align with major musical transitions (bridge/drop/finale).
- Penalize random palette shifts or high override_rate.
- Flag readability risk: overly complex palettes for high-contrast or low-detail constraints.

### Asset workload risk
- Frequent theme/palette shifts increase:
  - number of unique assets required
  - inconsistency risk across generated imagery
- Report risk as LOW/MED/HIGH with 1–2 sentence justification.

## Cross-Section Issue Reporting Format

For each cross-section issue, provide a `CrossSectionIssue`:

Required fields:
- `issue_id`: stable snake_case identifier (e.g., energy_arc_weak, theme_thrash, palette_overrides_excessive)
- `severity`: {{ taxonomy.IssueSeverity | join(' | ') }}
- `affected_sections`: list of section_ids (>=1)
- `description`: 2–4 sentences, specific
- `recommendation`: 1–2 sentence high-level summary of what should change
- `targeted_actions`: list of **specific, directly actionable** instructions (required for ERROR and WARN severity). Each action must reference concrete identifiers from the GroupPlanSet.

### Targeted Actions Format (Structured)

Each `targeted_action` is a structured `TargetedAction` object — NOT a free-text string. Every action must include:

- `action_type`: one of ADD_TARGET, REMOVE_TARGET, ADD_PLACEMENT, REMOVE_PLACEMENT, SWAP_TEMPLATE, CHANGE_PALETTE, CHANGE_THEME, ADD_MOTIF, REMOVE_MOTIF, ADJUST_TIMING, REORDER_GROUPS, OTHER
- `section_id`: which section to modify (required)
- `description`: human-readable explanation (required)

Optional fields (populate when relevant to the action_type):
- `lane`: BASE, RHYTHM, ACCENT, or BURST
- `target`: target reference e.g. "group:ARCHES", "zone:HOUSE", "split:ODD"
- `template_id`: template to add or swap from
- `replacement_template_id`: for SWAP_TEMPLATE, the new template
- `palette_id`: palette reference e.g. "core.peppermint"
- `bar`, `beat`: timing position
- `bar_end`: end bar for range-based actions

**Required fields per action_type:**
- ADD_TARGET / REMOVE_TARGET: `lane` + `target` required
- SWAP_TEMPLATE: `template_id` + `replacement_template_id` required
- CHANGE_PALETTE: `palette_id` required
- ADD_PLACEMENT: `lane` + `target` + `template_id` recommended
- OTHER: only `description` required

**Examples:**
```json
{"action_type": "ADD_TARGET", "section_id": "chorus_1", "lane": "ACCENT", "target": "group:STARS", "template_id": "gtpl_accent_motif_radial_rays_hit_small", "bar": 12, "beat": 1, "description": "Add STARS accent at chorus beacon reveal for sky glint"}
{"action_type": "CHANGE_PALETTE", "section_id": "instrumental", "palette_id": "core.peppermint", "description": "Keep instrumental in peppermint palette to preserve show identity"}
{"action_type": "SWAP_TEMPLATE", "section_id": "verse_4", "lane": "RHYTHM", "target": "group:ARCHES", "template_id": "gtpl_rhythm_sparkle_beat", "replacement_template_id": "gtpl_rhythm_wave_cascade", "description": "Replace sparkle beat with wave cascade for variety before finale"}
```

Do NOT invent additional fields or enum values.
