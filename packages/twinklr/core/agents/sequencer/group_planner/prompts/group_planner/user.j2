{#
GroupPlanner User Prompt
Provides planning context and task instructions
#}
# Song Information

**Title:** {{ audio_profile.song_identity.title or "Untitled" }}
**Artist:** {{ audio_profile.song_identity.artist or "Unknown" }}
**Duration:** {{ (audio_profile.song_identity.duration_ms / 1000) | round(1) }}s
**BPM:** {{ audio_profile.song_identity.bpm | round(1) }}
**Key:** {{ audio_profile.song_identity.key }}
**Time Signature:** {{ audio_profile.song_identity.time_signature }}

## Song Structure

{% for section in audio_profile.structure.sections %}
- **{{ section.name }}** ({{ section.section_id }}) - {{ (section.start_ms / 1000) | round(1) }}s to {{ (section.end_ms / 1000) | round(1) }}s
{% endfor %}

## Energy Profile

**Overall Energy:** {{ audio_profile.energy_profile.macro_energy }}

{% if audio_profile.energy_profile.peaks %}
**Energy Peaks:** {{ audio_profile.energy_profile.peaks | length }} major peaks detected
Peak timings:
{% for peak in audio_profile.energy_profile.peaks[:3] %}
- {{ (peak.start_ms / 1000) | round(1) }}s to {{ (peak.end_ms / 1000) | round(1) }}s (energy: {{ peak.energy | round(2) }})
{% endfor %}
{% if audio_profile.energy_profile.peaks | length > 3 %}
... and {{ audio_profile.energy_profile.peaks | length - 3 }} more peaks
{% endif %}
{% endif %}

{% if lyric_context is defined and lyric_context %}
## Lyric Context

**Has Lyrics:** Yes

**Themes:** {{ lyric_context.themes | join(", ") }}

**Mood Arc:** {{ lyric_context.mood_arc }}

{% if lyric_context.has_narrative %}
**Narrative:** Yes - {{ lyric_context.characters | length if lyric_context.characters else 0 }} character(s), {{ lyric_context.story_beats | length if lyric_context.story_beats else 0 }} story beat(s)

{% if lyric_context.story_beats %}
**Story Beats:**
{% for beat in lyric_context.story_beats[:3] %}
- **[{{ beat.beat_type }}]** {{ beat.section_id }} ({{ (beat.timestamp_range[0] / 1000) | round(1) }}s-{{ (beat.timestamp_range[1] / 1000) | round(1) }}s)
  {{ beat.description }}
  ðŸ’¡ {{ beat.visual_opportunity }}
{% endfor %}
{% if lyric_context.story_beats | length > 3 %}
... and {{ lyric_context.story_beats | length - 3 }} more story beats
{% endif %}
{% endif %}
{% endif %}

**Key Phrases:** {{ lyric_context.key_phrases | length }} memorable moments identified
{% if lyric_context.key_phrases %}
Notable examples:
{% for phrase in lyric_context.key_phrases[:3] %}
- "{{ phrase.text }}" @ {{ (phrase.timestamp_ms / 1000) | round(1) }}s [{{ phrase.emphasis }}]
  ðŸ’¡ {{ phrase.visual_hint }}
{% endfor %}
{% if lyric_context.key_phrases | length > 3 %}
... and {{ lyric_context.key_phrases | length - 3 }} more key phrases
{% endif %}
{% endif %}

**Recommended Visual Themes:** {{ lyric_context.recommended_visual_themes | join(", ") }}

**IMPORTANT:** Use the key phrases' visual hints and story beats to inform template selection. Match the narrative arc with visual progression.

{% endif %}
---

# MacroPlan Strategic Guidance

## Global Story

**Theme:** {{ macro_plan.global_story.theme }}

**Motifs:** {{ macro_plan.global_story.motifs | join(', ') }}

**Pacing Notes:** {{ macro_plan.global_story.pacing_notes }}

**Color Story:** {{ macro_plan.global_story.color_story }}

## Layering Plan

**Layer Count:** {{ macro_plan.layering_plan.layers | length }}

{% for layer in macro_plan.layering_plan.layers %}
### Layer {{ layer.layer_index }} ({{ layer.layer_role }}, {{ layer.blend_mode }} blend)

- **Usage Notes:** {{ layer.usage_notes }}
- **Timing Driver:** {{ layer.timing_driver }}
- **Target Roles:** {{ layer.target_selector.roles | join(', ') }}
- **Intensity Bias:** {{ layer.intensity_bias }}

{% endfor %}

## Section Plans

{% for section_plan in macro_plan.section_plans %}
### {{ section_plan.section.name }} ({{ (section_plan.section.start_ms / 1000) | round(1) }}s - {{ (section_plan.section.end_ms / 1000) | round(1) }}s)

- **Energy Target:** {{ section_plan.energy_target }}
- **Motion Density:** {{ section_plan.motion_density }}
- **Choreography Style:** {{ section_plan.choreography_style }}
- **Primary Focus:** {{ section_plan.primary_focus_targets | join(', ') if section_plan.primary_focus_targets else 'None' }}
- **Secondary Targets:** {{ section_plan.secondary_targets | join(', ') if section_plan.secondary_targets else 'None' }}
- **Notes:** {{ section_plan.notes }}

{% endfor %}

---

# Display Group

**Group ID:** {{ display_group.group_id }}
**Name:** {{ display_group.name }}
**Type:** {{ display_group.group_type }}
{% if display_group.model_count %}**Model Count:** {{ display_group.model_count }}{% endif %}
{% if display_group.tags %}**Tags:** {{ display_group.tags | join(', ') }}{% endif %}

---

# Available Templates

You may select from the following templates:

{% for template in available_templates %}
## {{ template.name }}
- **ID:** `{{ template.template_id }}`
- **Type:** {{ template.template_type }}
{% if template.description %}- **Description:** {{ template.description }}{% endif %}
{% if template.tags %}- **Tags:** {{ template.tags | join(', ') }}{% endif %}

{% endfor %}

**CRITICAL:** Only use template IDs from the list above. Do not invent new template IDs.

{% if iteration is defined and iteration > 1 %}
---

# Iteration {{ iteration }} - Refinement Feedback

{{ feedback }}

**Instructions:** Address the feedback above while maintaining coherence with the MacroPlan strategy.

{% endif %}
---

# Your Task

Create a GroupPlan for the **{{ display_group.name }}** display group that:

1. **Implements the MacroPlan strategy** - Follow layer architecture, section energy, choreography style
2. **Selects templates from catalog** - Choose appropriate templates for each layer/section
3. **Coordinates layers** - Multiple templates working together for depth
4. **Aligns with music** - Use bar-based timing that matches song structure
5. **Requests assets if needed** - Submit AssetRequest for custom imagery (optional)

Remember: Bold impact, musical coherence, follow the strategic guidance!
