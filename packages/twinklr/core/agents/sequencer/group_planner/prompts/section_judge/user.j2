{#
SectionJudge User Prompt
Provides section plan and context for evaluation
CATEGORICAL PLANNING VERSION
#}

# Section Plan to Evaluate

**Section ID:** {{ plan.section_id }}

## MacroPlan Intent for This Section

**Energy Target:** {{ energy_target }}
**Motion Density:** {{ motion_density }}
**Choreography Style:** {{ choreography_style }}
**Primary Focus Targets:** {{ primary_focus_targets | join(", ") }}
{% if secondary_targets %}
**Secondary Targets:** {{ secondary_targets | join(", ") }}
{% endif %}

## Section Theme + Palette + Motifs

**Theme ID:** {{ plan.theme.theme_id }}
**Theme Scope:** {{ plan.theme.scope }}
{% if plan.theme.tags %}
**Theme Tags:** {{ plan.theme.tags | join(", ") }}
{% else %}
**Theme Tags:** None
{% endif %}

{% if plan.palette %}
**Palette ID:** {{ plan.palette.palette_id }}
{% else %}
**Palette ID:** MISSING
{% endif %}

{% if plan.motif_ids %}
**Motif IDs:** {{ plan.motif_ids | join(", ") }}
{% else %}
**Motif IDs:** MISSING
{% endif %}

## Section Bounds

**Start:** {{ (start_ms / 1000) | round(1) }}s
**End:** {{ (end_ms / 1000) | round(1) }}s
**Duration:** {{ ((end_ms - start_ms) / 1000) | round(1) }}s

## Available Groups (by role)

{% for role, group_ids in display_graph.groups_by_role.items() %}
- **{{ role }}**: {{ group_ids | join(", ") }}
{% endfor %}

**Section intent roles (for coverage quality checks):** {{ priority_roles | join(", ") }}

## Available Zones (valid zone targets)

{% if display_graph.groups_by_tag is defined %}
{% for tag, group_ids in display_graph.groups_by_tag.items() %}
- **{{ tag }}**: {{ group_ids | join(", ") }}
{% endfor %}
{% endif %}

{% if display_graph.groups_by_split is defined and display_graph.groups_by_split %}
## Available Splits (valid split targets)

{% for split, group_ids in display_graph.groups_by_split.items() %}
- **{{ split }}**: {{ group_ids | join(", ") }}
{% endfor %}
{% endif %}

## Available Templates (Filtered â€” Same Set Shown to Planner)

{% for entry in template_catalog.entries %}
- `{{ entry.template_id }}` ({{ entry.compatible_lanes | map(attribute="value") | join(", ") }}) - {{ entry.name }}
  {% if entry.affinity_tags %}affinity: {{ entry.affinity_tags | join(", ") }}{% endif %}
{% endfor %}

{% if template_catalog_full and template_catalog_full.entries | length > template_catalog.entries | length %}
*({{ template_catalog_full.entries | length }} templates exist in total; {{ template_catalog.entries | length }} were shown to the planner for this section's energy/motifs. A template_id is valid if it appears in either catalog.)*
{% endif %}

---

## Plan JSON

```json
{{ plan | tojson(indent=2) }}
```

---

# Judge Instructions

## Categorical Planning Checks

This plan uses **categorical values**:

**Intensity Levels:** WHISPER, SOFT, MED, STRONG, PEAK
- Check if levels match section energy ({{ energy_target }}):
  {% if energy_target == "LOW" %}- Prefer WHISPER, SOFT, MED - warn if PEAK used{% elif energy_target == "HIGH" %}- Prefer MED, STRONG, PEAK - warn if WHISPER used{% else %}- Prefer SOFT, MED, STRONG{% endif %}

**Effect Durations:** HIT, BURST, PHRASE, EXTENDED, SECTION
- Check if durations match musical intent

1) **Technical Validation**
- template_ids exist and are lane-compatible
- targets are valid: group ids exist in display graph, zone ids are valid zones (see above), split ids are valid splits (see above)
- start timing within section bounds
- duration is valid enum (HIT, BURST, PHRASE, EXTENDED, SECTION)
- intensity is valid enum (WHISPER, SOFT, MED, STRONG, PEAK)
- no same-target self-overlap within a lane (same type+id; different targets may overlap)
- if mode requires expansion (SEQUENCED/CALL_RESPONSE/RIPPLE): window+config must be present and valid
- theme must be SECTION-scoped; tags <= 5
- palette must be present with palette_id
- motif_ids must be present and non-empty

2) **Quality Assessment**
- templates appropriate for lanes + section intent
- coordination readable + coherent
- primary targets get meaningful ACCENT treatment
- **energy alignment**: intensity levels match energy target ({{ energy_target }})
- motion density matches complexity
- palette/motif choices are respected (no invented ids) and support a cohesive visual

{% if iteration is defined and iteration > 0 %}
## Iteration {{ iteration + 1 }}

Check whether prior issues were addressed. Give credit for improvements and focus on remaining issues.
{% else %}
## First Iteration

Provide comprehensive feedback to guide refinement.
{% endif %}

Return a JudgeVerdict JSON only.
