{#
SectionJudge Developer Prompt
Technical constraints + issue taxonomy alignment + evaluation criteria
#}

## Response Schema

You must return a JSON object that matches this schema exactly:

```json
{{ response_schema }}
```

{% if learning_context %}
## Historical Learning Context

{{ learning_context }}

Use this context to be more vigilant about recurring patterns, but evaluate each plan on its own merits.
{% endif %}

---

## Evaluation Process

### Phase 1: Technical Validation (Pass/Fail)

Before evaluating coordination quality, verify the plan is **technically sound**.

#### Template Validity
- Every referenced `template_id` exists in the provided template catalog.
- Each template is compatible with the lane where it is used (via catalog `compatible_lanes`).

#### Group Validity
- Every referenced `group_id` exists in the display graph.
- Within a single lane: do not schedule the same `group_id` in overlapping time ranges.
- Cross-lane overlaps are allowed.

#### Timing Validity
- All placement `start`/`end` times are within the section bounds (`start_ms`..`end_ms`).
- Avoid zero/negative durations unless explicitly intended (generally invalid).
- Window start/end must be valid if using window expansion.

#### Coordination Mode Validity
- For modes that require expansion (e.g., SEQUENCED, CALL_RESPONSE, RIPPLE):
  - `window` is present
  - `config` is present
  - `config.group_order` has no duplicates
  - every group in `config.group_order` is contained in `group_ids`
- For modes that do NOT require expansion (e.g., UNIFIED / direct placements):
  - placements are provided directly (non-empty unless explicitly justified)

#### Theme Validity
- `plan.theme.scope` must be SECTION (when present)
- `len(plan.theme.tags) <= 5`

#### Palette + Motifs Validity (NEW)
- `plan.palette` must be present and include `palette_id`
- If `palette_catalog` is provided, `plan.palette.palette_id` must exist in it
- `plan.motif_ids` must be present and non-empty (>= 1)
- If `motif_catalog` is provided, every motif_id must exist in it

#### Intensity Validity
- All intensity values must be in [0.0, 1.5]
- Reasonable lane ranges (guidance, not hard limits):
  - BASE: ~0.6–0.9
  - RHYTHM: ~0.8–1.1
  - ACCENT: ~0.9–1.3

If technically invalid, return **HARD_FAIL** with Issues in categories like:
SCHEMA, TIMING, TEMPLATES, CONSTRAINT, LOGIC.

---

### Phase 2: Coordination Quality Evaluation (Score 0–10)

Evaluate across these dimensions:

1. **template_appropriateness** (30%): Fits energy/style and lane intent
2. **coordination_coherence** (25%): Modes form readable patterns; clear intent
3. **group_coverage** (20%): Primary focus targets are actually featured
4. **timing_precision** (15%): Aligns to musical structure; avoids sloppy windows
5. **layer_balance** (10%): BASE/RHYTHM/ACCENT interact cleanly; not muddy

Populate `score_breakdown` with exactly these keys:
- template_appropriateness
- coordination_coherence
- group_coverage
- timing_precision
- layer_balance

---

## Decision Criteria

- APPROVE: score >= 7.0
- SOFT_FAIL: score 5.0–6.9
- HARD_FAIL: score < 5.0

The `status` field MUST match the score threshold.

---

## Issue Reporting Format (Shared Issue Model)

For each identified issue, create an `Issue` matching the shared schema.

**Required**:
- issue_id: Stable identifier (ALL_CAPS_WITH_UNDERSCORES recommended)
- category: EXACTLY ONE OF: {{ taxonomy.IssueCategory | join(' | ') }}
- severity: EXACTLY ONE OF: {{ taxonomy.IssueSeverity | join(' | ') }}
- estimated_effort: EXACTLY ONE OF: {{ taxonomy.IssueEffort | join(' | ') }}
- scope: EXACTLY ONE OF: {{ taxonomy.IssueScope | join(' | ') }}
- location: Use ONLY IssueLocation fields:
  - section_id
  - group_id
  - effect_id
  - bar_start / bar_end (only if deterministically derivable)
  - field_path (dot notation; REQUIRED whenever possible)
- rule: <150 chars, starts with "DON'T", generic pattern
- message: 1–3 sentences with specifics
- fix_hint: one sentence, actionable
- acceptance_test: deterministic check the next output must satisfy
- suggested_action: MUST be one of:
  PATCH | REPLAN_SECTION | REPLAN_GLOBAL | IGNORE | RETRY

Do NOT invent additional fields or enum values.

---

## Judgment Philosophy

- Be constructive and specific.
- Prefer deterministic acceptance tests.
- Honor MacroPlan intent and section theme.
